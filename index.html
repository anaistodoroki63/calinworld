<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Hugsaur ğŸ±ğŸ¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

/* ============================ */
/*      STYLE GLOBAL KAWAII      */
/* ============================ */

body {
  margin:0;
  padding:0;
  font-family: 'Comic Sans MS', sans-serif;
  background: linear-gradient(135deg, #ffd6e8, #ffe4f2);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.container {
  width:95%;
  max-width:480px;
  background:white;
  border-radius:25px;
  padding:20px;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
  text-align:center;
}

input, select {
  width:90%;
  padding:10px;
  border-radius:15px;
  border:2px solid #ffb6c1;
  margin:6px 0;
}

button {
  background:#ff69b4;
  color:white;
  border:none;
  padding:10px 20px;
  border-radius:20px;
  cursor:pointer;
  margin-top:8px;
}

button:hover {
  filter:brightness(1.1);
}

/* panneaux */
.box { display:none; margin-top:15px; }

/* ============================ */
/*      AVATARS CHIBI PACK      */
/* ============================ */

.avatar {
  width:64px;
  height:64px;
  border-radius:50%;
  margin:4px;
  border:3px solid #ffb6c1;
}

.avatar-select {
  width:72px;
  height:72px;
  border-radius:50%;
  margin:4px;
  border:4px solid transparent;
  cursor:pointer;
}

.avatar-select.selected {
  border-color:#ff69b4;
}

</style>
</head>
<body>
<div class="container">

<h1>Hugsaur ğŸ±ğŸ¤</h1>

  <!-- ============================ -->
<!-- PACK AVATARS KAWAII CHIBI    -->
<!-- ============================ -->

<div id="avatarSelection" style="display:none;">
  <h3>Choisis ton avatar ğŸ˜º</h3>
  <div id="avatarList"></div>
  <button onclick="validerAvatar()">Valider âœ¨</button>
</div>

  <script>
const AVATARS = [
  { id:"cat_white",  src:"data:image/png;base64,AAAA...==" },
  { id:"cat_black",  src:"data:image/png;base64,BBBB...==" },
  { id:"cat_orange", src:"data:image/png;base64,CCCC...==" }
  // + 7 autres ajoutÃ©s partie 3
];
</script>

  <!-- ============================ -->
<!--        AUTH / LOGIN          -->
<!-- ============================ -->

<div id="authBox">
  <h3>CrÃ©er un compte</h3>
  <input id="emailRegister" type="email" placeholder="Email ğŸ’Œ">
  <input id="passwordRegister" type="password" placeholder="Mot de passe ğŸ”’">
  <input id="pseudoRegister" placeholder="Pseudo kawaii ğŸ±">
  <button onclick="register()">CrÃ©er âœ¨</button>

  <hr>

  <h3>Connexion</h3>
  <input id="emailLogin" type="email" placeholder="Email ğŸ’Œ">
  <input id="passwordLogin" type="password" placeholder="Mot de passe ğŸ”’">
  <button onclick="login()">Connexion ğŸ¤—</button>
</div>


<!-- ============================ -->
<!--          DASHBOARD           -->
<!-- ============================ -->

<div id="userBox" style="display:none;">
  <img id="myAvatar" class="avatar"><br>
  <h2><span id="pseudoDisplay"></span> ğŸ˜½</h2>
  <div id="statsBox"></div>
  <br>

  <button onclick="openBox('friendsBox')">ğŸ‘« Amis</button>
  <button onclick="openBox('hugBox')">ğŸ± CÃ¢lins</button>
  <button onclick="openBox('dmBox')">ğŸ’¬ Messages</button>
  <button onclick="openBox('shopBox')">ğŸ Boutique</button>
  <button onclick="openBox('inventoryBox')">ğŸ’ Inventaire</button>
  <button onclick="openBox('rankBox')">ğŸŒŸ Classement</button>
  <button onclick="openBox('profileBox')">ğŸ˜º Profil</button>
  <br><br>
  <button onclick="logout()">DÃ©connexion ğŸšª</button>
</div>

  <div id="friendsBox" class="box">
  <h3>ğŸ‘« Amis</h3>
  <input id="amiPseudo" placeholder="Pseudo ğŸ±">
  <button onclick="sendFriendRequest()">Ajouter ğŸ¤</button>
  <h4>Demandes reÃ§ues :</h4>
  <div id="friendRequests"></div>
  <h4>Mes amis :</h4>
  <div id="friendList"></div>
</div>

<div id="hugBox" class="box">
  <h3>ğŸ± CÃ¢lins</h3>
  <select id="hugTarget"></select>
  <button onclick="requestHug()">Demander ğŸ±ğŸ¤</button>
  <h4>Demandes reÃ§ues :</h4>
  <div id="hugRequests"></div>
</div>

<div id="dmBox" class="box">
  <h3>ğŸ’¬ Messages privÃ©s</h3>
  <select id="dmTarget"></select>
  <div id="dmMessages" style="max-height:200px;overflow:auto;"></div>
  <input id="dmInput" placeholder="Message ğŸ¾">
  <button onclick="sendDM()">Envoyer ğŸ’Œ</button>
</div>

<div id="shopBox" class="box">
  <h3>ğŸ Boutique</h3>
  <div id="shopItems"></div>
</div>

<div id="inventoryBox" class="box">
  <h3>ğŸ’ Inventaire</h3>
  <div id="inventory"></div>
</div>

<div id="rankBox" class="box">
  <h3>ğŸŒŸ Classement</h3>
  <div id="rankList"></div>
</div>

<div id="profileBox" class="box">
  <h3>ğŸ˜º Profil</h3>
  <p>Avatar : <img id="profileAvatar" class="avatar"></p>
  <p>Pseudo : <span id="profilePseudo"></span></p>
  <p>Bio :</p>
  <textarea id="profileBio" style="width:90%;height:80px;"></textarea><br>
  <button onclick="saveBio()">Sauvegarder âœ¨</button>
</div>

  <script>
/* ========================================================= */
/*                 PACK AVATARS CHIBI (10)                   */
/* ========================================================= */

const AVATARS = [
  { id:"cat_white",  src:"data:image/png;base64,iVBORw0KGgoAAA..." },
  { id:"cat_black",  src:"data:image/png;base64,iVBORw0KGgoAAA..." },
  { id:"cat_orange", src:"data:image/png;base64,iVBORw0KGgoAAA..." },
  { id:"cat_gray",   src:"data:image/png;base64,iVBORw0KGgoAAA..." },
  { id:"cat_calico", src:"data:image/png;base64,iVBORw0KGgoAAA..." },
  { id:"cat_sakura", src:"data:image/png;base64,iVBORw0KGgoAAA..." },
  { id:"cat_princess",src:"data:image/png;base64,iVBORw0KGgoAAA..." },
  { id:"cat_demon",  src:"data:image/png;base64,iVBORw0KGgoAAA..." },
  { id:"cat_samurai",src:"data:image/png;base64,iVBORw0KGgoAAA..." },
  { id:"cat_magic",  src:"data:image/png;base64,iVBORw0KGgoAAA..." }
];

let SELECTED_AVATAR = null;

/* ========================================================= */
/*                   RENDU SELECTION AVATAR                  */
/* ========================================================= */

function showAvatarSelection() {
  authBox.style.display = "none";
  avatarSelection.style.display = "block";

  avatarList.innerHTML = "";
  AVATARS.forEach(a=>{
    const img=document.createElement("img");
    img.src=a.src;
    img.className="avatar-select";
    img.dataset.id=a.id;
    img.onclick=()=>selectAvatar(img,a.id);
    avatarList.appendChild(img);
  });
}

function selectAvatar(el,id) {
  SELECTED_AVATAR = id;
  document.querySelectorAll('.avatar-select').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
}

function validerAvatar() {
  if(!SELECTED_AVATAR){
    alert("Choisis un avatar ğŸ˜º");
    return;
  }
  document.getElementById("registerAvatarFinal").value = SELECTED_AVATAR;
  avatarSelection.style.display="none";
  authBox.style.display="block";
}

/* ========================================================= */
/*                       EXTRA INPUT HIDDEN                  */
/* ========================================================= */
document.write(`<input type="hidden" id="registerAvatarFinal">`);
</script>

  <!-- ========================================================= -->
<!--                 FIREBASE + AUTH + USERS                    -->
<!-- ========================================================= -->

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>

/* ========================================================= */
/*                 CONFIG FIREBASE (Ã€ REMPLACER)             */
/* ========================================================= */

const firebaseConfig = {
  apiKey: "AIzaSyAJ9Cn4YVIw5SgKmJ31BJCq8Dx6sGdYbLc",
  authDomain: "calinworld-568d1.firebaseapp.com",
  projectId: "calinworld-568d1",
  storageBucket: "calinworld-568d1.firebasestorage.app",
  messagingSenderId: "474110538958",
  appId: "1:474110538958:web:160db43f618b4295c0cc9f"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ========================================================= */
/*                   OPEN PANNEAUX UI                         */
/* ========================================================= */

function openBox(id){
  document.querySelectorAll('.box').forEach(b=>b.style.display='none');
  document.getElementById(id).style.display='block';
}

/* ========================================================= */
/*                       REGISTER                              */
/* ========================================================= */

function register(){
  const email=emailRegister.value;
  const pass=passwordRegister.value;
  const pseudo=pseudoRegister.value.trim();

  if(!email||!pass||!pseudo){
    alert("ComplÃ¨te tout ğŸ˜º");
    return;
  }

  if(!SELECTED_AVATAR){
    showAvatarSelection();
    return;
  }

  const avatar = SELECTED_AVATAR;

  auth.createUserWithEmailAndPassword(email,pass).then(()=>{
    db.collection("users").doc(email).set({
      email,
      pseudo,
      avatar,
      bio:"",
      title:"Nouveau chaton ğŸ¾",
      friends:[],
      hugsSent:0,
      hugsReceived:0,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Compte crÃ©Ã© ğŸ˜½âœ¨");
  }).catch(e=>alert(e.message));
}
/* ========================================================= */
/*                       LOGIN                                */
/* ========================================================= */

function login(){
  auth.signInWithEmailAndPassword(emailLogin.value,passwordLogin.value)
  .catch(e=>alert(e.message));
}

function logout(){auth.signOut();}

/* ========================================================= */
/*                 ON AUTH CHANGE + RENDU UI                  */
/* ========================================================= */

auth.onAuthStateChanged(user=>{
  if(!user){
    userBox.style.display="none";
    authBox.style.display="block";
    return;
  }

  authBox.style.display="none";
  userBox.style.display="block";

  const email = user.email;

  // Track du profil utilisateur
  db.collection("users").doc(email).onSnapshot(doc=>{
    const u = doc.data();

    // pseudo + titre + avatar
    pseudoDisplay.textContent = u.pseudo;
    myAvatar.src = AVATARS.find(x=>x.id===u.avatar)?.src || "";

    // stats
    statsBox.innerHTML = `
      ğŸ‘« Amis : ${u.friends.length}<br>
      ğŸ¤— EnvoyÃ©s : ${u.hugsSent}<br>
      ğŸ’– ReÃ§us : ${u.hugsReceived}
    `;

    // profil
    profileAvatar.src = myAvatar.src;
    profilePseudo.textContent = u.pseudo;
    profileBio.value = u.bio || "";
  });

  // chargement UI
  loadFriends();
  loadFriendRequests();
  loadFriendsForHugs();
  loadFriendsForDM();
  loadHugRequests();
  loadRank();
  loadInventory();
  loadShop();
});

/* ========================================================= */
/*                SAUVEGARDE BIO PROFIL                       */
/* ========================================================= */

function saveBio(){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).update({
    bio:profileBio.value
  });
  alert("Bio sauvegardÃ©e ğŸ˜ºâœ¨");
}

</script>

  <script>

/* ========================================================= */
/*                       MODULE AMIS                         */
/* ========================================================= */

function sendFriendRequest(){
  const pseudoCible = amiPseudo.value.trim();
  if(!pseudoCible){ alert("Entre un pseudo ğŸ±"); return; }

  const email = auth.currentUser.email;

  db.collection("users").doc(email).get().then(doc=>{
    const pseudoMoi = doc.data().pseudo;

    if(pseudoMoi === pseudoCible){
      alert("Tu ne peux pas t'ajouter toi-mÃªme ğŸ˜¹");
      return;
    }

    // Recherche du compte cible
    db.collection("users").where("pseudo","==",pseudoCible).limit(1).get().then(snap=>{
      if(snap.empty){
        alert("Ce pseudo n'existe pas ğŸ˜¿");
        return;
      }

      db.collection("friendRequests").add({
        from:pseudoMoi,
        to:pseudoCible,
        status:"pending",
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });

      alert("Demande envoyÃ©e ğŸ¤");
    });
  });
}

/* ========================================================= */
/*                    MODULE CÃ‚LINS CIBLÃ‰S                   */
/* ========================================================= */

function loadFriendsForHugs(){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).onSnapshot(doc=>{
    hugTarget.innerHTML="";
    doc.data().friends.forEach(f=>{
      hugTarget.innerHTML+=`<option value="${f}">${f}</option>`;
    });
  });
}

function requestHug(){
  const email=auth.currentUser.email;
  const target=hugTarget.value;
  if(!target){ alert("Tu n'as pas d'amis ğŸ˜¿"); return; }

  db.collection("users").doc(email).get().then(doc=>{
    const pseudo=doc.data().pseudo;
    db.collection("hugRequests").add({
      from:pseudo,
      to:target,
      status:"pending",
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Demande de cÃ¢lin envoyÃ©e Ã  "+target+" ğŸ±ğŸ¤");
  });
}

function loadHugRequests(){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).get().then(doc=>{
    const pseudo=doc.data().pseudo;
    db.collection("hugRequests")
      .where("to","==",pseudo)
      .where("status","==","pending")
      .onSnapshot(s=>{
        hugRequests.innerHTML="";
        s.forEach(d=>{
          hugRequests.innerHTML+=`
            ${d.data().from} veut un cÃ¢lin ğŸ±ğŸ¤<br>
            <button onclick="acceptHug('${d.id}','${d.data().from}')">Accepter ğŸ’–</button>
            <button onclick="rejectHug('${d.id}')">Refuser ğŸ˜¿</button>
            <br><br>
          `;
        });
      });
  });
}

function acceptHug(id,from){
  const email=auth.currentUser.email;

  db.collection("users").doc(email).update({
    hugsReceived:firebase.firestore.FieldValue.increment(1)
  });

  db.collection("users").where("pseudo","==",from).get().then(snap=>{
    snap.forEach(u=>{
      db.collection("users").doc(u.id).update({
        hugsSent:firebase.firestore.FieldValue.increment(1)
      });
    });
  });

  db.collection("hugRequests").doc(id).update({status:"accepted"});
}

function rejectHug(id){
  db.collection("hugRequests").doc(id).update({status:"rejected"});
}

/* ========================================================= */
/*                  MODULE MESSAGES PRIVÃ‰S DM                */
/* ========================================================= */

function loadFriendsForDM(){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).onSnapshot(doc=>{
    dmTarget.innerHTML="";
    doc.data().friends.forEach(f=>{
      dmTarget.innerHTML+=`<option value="${f}">${f}</option>`;
    });
  });

  loadDM();
}

function sendDM(){
  const msg=dmInput.value.trim();
  if(!msg)return;
  const target=dmTarget.value;
  const email=auth.currentUser.email;

  db.collection("users").doc(email).get().then(doc=>{
    const sender=doc.data().pseudo;
    db.collection("messages").add({
      from:sender,
      to:target,
      msg,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    dmInput.value="";
  });
}

function loadDM(){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).get().then(doc=>{
    const pseudo=doc.data().pseudo;

    db.collection("messages")
      .orderBy("createdAt")
      .onSnapshot(s=>{
        dmMessages.innerHTML="";
        s.forEach(d=>{
          const m=d.data();
          if(m.from===pseudo && m.to===dmTarget.value) dmMessages.innerHTML+=`<div>â¡ï¸ ${m.msg}</div>`;
          if(m.to===pseudo && m.from===dmTarget.value) dmMessages.innerHTML+=`<div>â¬…ï¸ ${m.msg}</div>`;
        });
      });
  });
}

/* ========================================================= */
/*                        BOUTIQUE                            */
/* ========================================================= */

const SHOP_ITEMS = [
  {id:"gift_heart",name:"CÅ“ur ğŸ’–",cost:0},
  {id:"gift_star",name:"Ã‰toile â­",cost:0},
  {id:"gift_ribbon",name:"Ruban ğŸ€",cost:0}
];

function loadShop(){
  shopItems.innerHTML="";
  SHOP_ITEMS.forEach(i=>{
    shopItems.innerHTML+=`${i.name} <button onclick="buyItem('${i.id}')">Obtenir ğŸ</button><br>`;
  });
}

function buyItem(id){
  const email=auth.currentUser.email;
  db.collection("inventory").add({
    owner:email,
    item:id,
    acquiredAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Objet ajoutÃ© ğŸ");
}

function loadInventory(){
  const email=auth.currentUser.email;
  db.collection("inventory")
    .where("owner","==",email)
    .onSnapshot(s=>{
      inventory.innerHTML="";
      s.forEach(d=>{
        inventory.innerHTML+=`${d.data().item}<br>`;
      });
    });
}

/* ========================================================= */
/*                         CLASSEMENT                         */
/* ========================================================= */

function loadRank(){
  db.collection("users")
    .orderBy("hugsReceived","desc")
    .limit(10)
    .onSnapshot(s=>{
      rankList.innerHTML="";
      let i=1;
      s.forEach(d=>{
        rankList.innerHTML+=`${i++}. ${d.data().pseudo} â€” ğŸ’– ${d.data().hugsReceived}<br>`;
      });
    });
}

</script>
</body>
</html>

