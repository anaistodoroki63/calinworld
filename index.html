<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Hugsaur ğŸ±ğŸ¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: 'Comic Sans MS', Arial, sans-serif;
  background: linear-gradient(135deg, #ffd6e8, #ffe4f2);
  margin:0;
  padding:0;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.container {
  width:90%;
  max-width:480px;
  background:white;
  border-radius:25px;
  box-shadow:0 10px 25px rgba(0,0,0,0.15);
  padding:20px;
  text-align:center;
}
input {
  width:90%;
  padding:10px;
  border-radius:15px;
  border:2px solid #ffb6c1;
  margin:6px 0;
}
button {
  background:#ff69b4;
  color:white;
  border:none;
  padding:10px 20px;
  border-radius:20px;
  cursor:pointer;
  margin-top:8px;
}
.box {display:none;margin-top:15px;}
hr {margin:15px 0;}
.message {margin:4px 0;font-size:14px;}
</style>
</head>

<body>
<div class="container">
  <h1>Hugsaur ğŸ±ğŸ¤</h1>

  <!-- Auth Box -->
  <div id="authBox">
    <h3>CrÃ©er un compte</h3>
    <input id="emailRegister" type="email" placeholder="Email ğŸ’Œ">
    <input id="passwordRegister" type="password" placeholder="Mot de passe ğŸ”’">
    <input id="pseudoRegister" placeholder="Pseudo kawaii ğŸ±">
    <button onclick="register()">CrÃ©er un compte âœ¨</button>
    <hr>
    <h3>Connexion</h3>
    <input id="emailLogin" type="email" placeholder="Email ğŸ’Œ">
    <input id="passwordLogin" type="password" placeholder="Mot de passe ğŸ”’">
    <button onclick="login()">Connexion ğŸ¤—</button>
  </div>

  <!-- User Box -->
  <div id="userBox" style="display:none;">
    <h2>Bienvenue <span id="pseudoDisplay"></span> ğŸ˜½</h2>
    <div id="statsBox"></div>
    <br>
    <button onclick="openBox('friendsBox')">ğŸ‘« Amis</button>
    <button onclick="openBox('hugBox')">ğŸ± CÃ¢lins</button>
    <button onclick="openBox('rankBox')">ğŸŒŸ Classement</button>
    <button onclick="openBox('badgeBox')">ğŸ† Badges</button>
    <button onclick="openBox('chatBox')">ğŸ’¬ Chat</button>
    <br><br>
    <button onclick="logout()">DÃ©connexion ğŸšª</button>
  </div>

  <!-- Friends -->
  <div id="friendsBox" class="box">
    <h3>ğŸ‘« Amis</h3>
    <input id="amiPseudo" placeholder="Pseudo Ã  ajouter ğŸ±">
    <button onclick="sendFriendRequest()">Ajouter ğŸ¤</button>
    <h4>Demandes reÃ§ues :</h4>
    <div id="friendRequests"></div>
    <h4>Mes amis :</h4>
    <div id="friendList"></div>
  </div>

  <!-- Hugs -->
  <div id="hugBox" class="box">
    <h3>ğŸ± Demandes de cÃ¢lins</h3>
    <button onclick="requestHug()">Demander un cÃ¢lin ğŸ±ğŸ¤</button>
    <div id="hugRequests"></div>
  </div>

  <!-- Ranking -->
  <div id="rankBox" class="box">
    <h3>ğŸŒŸ Classement des cÃ¢lins</h3>
    <div id="rankList"></div>
  </div>

  <!-- Badges -->
  <div id="badgeBox" class="box">
    <h3>ğŸ† Badges</h3>
    <div id="badgeList"></div>
  </div>

  <!-- Chat -->
  <div id="chatBox" class="box">
    <h3>ğŸ’¬ Chat kawaii</h3>
    <div id="chatMessages"></div>
    <input id="chatInput" placeholder="Message ğŸ¾">
    <button onclick="sendChat()">Envoyer ğŸ’Œ</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ğŸ”¥ REMPLACER CE BLOC PAR TON CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAJ9Cn4YVIw5SgKmJ31BJCq8Dx6sGdYbLc",
  authDomain: "calinworld-568d1.firebaseapp.com",
  projectId: "calinworld-568d1",
  storageBucket: "calinworld-568d1.firebasestorage.app",
  messagingSenderId: "474110538958",
  appId: "1:474110538958:web:160db43f618b4295c0cc9f"
};
/* ğŸ”¥ FIN DU BLOC */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function openBox(id){
  document.querySelectorAll('.box').forEach(b=>b.style.display='none');
  document.getElementById(id).style.display='block';
}

function register(){
  const email=emailRegister.value;
  const pass=passwordRegister.value;
  const pseudo=pseudoRegister.value;
  auth.createUserWithEmailAndPassword(email,pass).then(()=>{
    db.collection("users").doc(email).set({
      email,pseudo,
      hugsSent:0,hugsReceived:0,
      badges:[],friends:[],
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Bienvenue sur Hugsaur ğŸ±ğŸ¤");
  }).catch(e=>alert(e.message));
}

function login(){
  auth.signInWithEmailAndPassword(emailLogin.value,passwordLogin.value)
  .catch(e=>alert(e.message));
}

function logout(){auth.signOut();}

auth.onAuthStateChanged(user=>{
  if(!user){
    authBox.style.display="block";
    userBox.style.display="none";
    return;
  }
  authBox.style.display="none";
  userBox.style.display="block";

  db.collection("users").doc(user.email).onSnapshot(doc=>{
    const u=doc.data();
    pseudoDisplay.textContent=u.pseudo;
    statsBox.innerHTML=`ğŸ± Amis: ${u.friends.length}<br>ğŸ¤— EnvoyÃ©s: ${u.hugsSent}<br>ğŸ’– ReÃ§us: ${u.hugsReceived}`;
  });

  loadFriends();
  loadFriendRequests();
  loadRank();
  loadBadges();
  loadChat();
  loadHugRequests();
});

/* ==================== AMIS ==================== */
function sendFriendRequest(){
  const pseudo=amiPseudo.value.trim();
  if(!pseudo){alert("Entre un pseudo ğŸ±");return;}
  const email=auth.currentUser.email;
  db.collection("users").doc(email).get().then(doc=>{
    const mine=doc.data().pseudo;
    db.collection("friendRequests").add({from:mine,to:pseudo,status:"pending"});
    alert("Demande envoyÃ©e ğŸ¤");
  });
}

function loadFriendRequests(){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).get().then(doc=>{
    const mine=doc.data().pseudo;
    db.collection("friendRequests").where("to","==",mine).where("status","==","pending")
    .onSnapshot(s=>{
      friendRequests.innerHTML="";
      s.forEach(d=>{
        friendRequests.innerHTML+=`${d.data().from} te demande ğŸ¥º 
        <button onclick="acceptFriend('${d.id}','${d.data().from}')">Accepter ğŸ’–</button>
        <button onclick="rejectFriend('${d.id}')">Refuser ğŸ˜¿</button><br>`;
      });
    });
  });
}

function acceptFriend(id,from){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).update({
    friends:firebase.firestore.FieldValue.arrayUnion(from)
  });
  db.collection("friendRequests").doc(id).update({status:"accepted"});
}

function rejectFriend(id){
  db.collection("friendRequests").doc(id).update({status:"rejected"});
}

function loadFriends(){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).onSnapshot(doc=>{
    friendList.innerHTML=doc.data().friends.map(f=>`ğŸ± ${f}`).join("<br>");
  });
}

/* ==================== CÃ‚LINS ==================== */

function requestHug(){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).get().then(doc=>{
    const pseudo=doc.data().pseudo;
    doc.data().friends.forEach(f=>{
      db.collection("hugRequests").add({from:pseudo,to:f,status:"pending"});
    });
    alert("Demande de cÃ¢lin envoyÃ©e ğŸ±ğŸ¤");
  });
}

function loadHugRequests(){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).get().then(doc=>{
    const pseudo=doc.data().pseudo;
    db.collection("hugRequests").where("to","==",pseudo).where("status","==","pending")
    .onSnapshot(s=>{
      hugRequests.innerHTML="";
      s.forEach(d=>{
        hugRequests.innerHTML+=`${d.data().from} veut un cÃ¢lin ğŸ±ğŸ¤ 
        <button onclick="acceptHug('${d.id}','${d.data().from}')">Accepter ğŸ’–</button>
        <button onclick="rejectHug('${d.id}')">Refuser ğŸ˜¿</button><br>`;
      });
    });
  });
}

function acceptHug(id,from){
  const email=auth.currentUser.email;
  db.collection("users").doc(email).get().then(doc=>{
    const me=doc.data().pseudo;
    db.collection("users").doc(auth.currentUser.email).update({
      hugsReceived:firebase.firestore.FieldValue.increment(1)
    });
    db.collection("users").where("pseudo","==",from).get().then(snap=>{
      snap.forEach(u=>{
        db.collection("users").doc(u.id).update({
          hugsSent:firebase.firestore.FieldValue.increment(1)
        });
      });
    });
    db.collection("hugRequests").doc(id).update({status:"accepted"});
  });
}

function rejectHug(id){
  db.collection("hugRequests").doc(id).update({status:"rejected"});
}

/* ==================== CLASSEMENT ==================== */
function loadRank(){
  db.collection("users").orderBy("hugsReceived","desc").limit(10)
  .onSnapshot(s=>{
    rankList.innerHTML="";
    let i=1;
    s.forEach(d=>{
      rankList.innerHTML+=`${i++}. ${d.data().pseudo} â€” ğŸ’– ${d.data().hugsReceived}<br>`;
    });
  });
}

/* ==================== BADGES ==================== */
function loadBadges(){
  db.collection("users").doc(auth.currentUser.email).onSnapshot(doc=>{
    const u=doc.data();
    const b=[];
    if(u.hugsReceived>=1)b.push("Premier cÃ¢lin ğŸ¾");
    if(u.hugsReceived>=10)b.push("CÃ¢lineur confirmÃ© ğŸ˜½");
    if(u.hugsReceived>=50)b.push("CÃ¢lineur expert ğŸŒŸ");
    badgeList.innerHTML=b.join("<br>");
  });
}

/* ==================== CHAT ==================== */
function sendChat(){
  const msg=chatInput.value.trim();
  if(!msg)return;
  db.collection("chat").add({
    pseudo:pseudoDisplay.textContent,
    msg,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  chatInput.value="";
}

function loadChat(){
  db.collection("chat").orderBy("createdAt")
  .onSnapshot(s=>{
    chatMessages.innerHTML="";
    s.forEach(d=>{
      chatMessages.innerHTML+=`<div class="message">ğŸ± <b>${d.data().pseudo}:</b> ${d.data().msg}</div>`;
    });
  });
}
</script>

</body>
</html>
