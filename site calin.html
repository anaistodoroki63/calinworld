<script>
document.addEventListener('DOMContentLoaded', () => {
  // Keys
  const FRIENDS_KEY = 'calin_friends_v1';
  const TOTAL_KEY = 'calin_total_v1';

  // Query elements (done after DOM loaded)
  const friendNameInput = document.getElementById('friendName');
  const addFriendBtn = document.getElementById('addFriend');
  const friendsListEl = document.getElementById('friendsList');
  const selectAllBtn = document.getElementById('selectAll');
  const clearSelBtn = document.getElementById('clearSel');
  const hugSelectedBtn = document.getElementById('hugSelected');
  const hugAllBtn = document.getElementById('hugAll');
  const resetAllBtn = document.getElementById('resetAll');
  const heroBtn = document.getElementById('hugInHero');
  const heroTotalCountEl = document.getElementById('heroTotalCount');
  const friendsTitle = document.getElementById('friendsTitle');

  // Basic guards
  if (!friendsListEl || !friendNameInput || !addFriendBtn) {
    console.error('√âl√©ments principaux introuvables :', {
      friendsListEl: !!friendsListEl,
      friendNameInput: !!friendNameInput,
      addFriendBtn: !!addFriendBtn
    });
    // still try to proceed if possible
  }

  // State helpers
  function loadFriends(){
    try { return JSON.parse(localStorage.getItem(FRIENDS_KEY) || '[]'); }
    catch(e){ return []; }
  }
  function saveFriends(f){ localStorage.setItem(FRIENDS_KEY, JSON.stringify(f)); }
  function loadTotal(){ return parseInt(localStorage.getItem(TOTAL_KEY) || '0', 10); }
  function saveTotal(t){ localStorage.setItem(TOTAL_KEY, String(t)); }

  function uid(){ return 'f_' + Math.random().toString(36).slice(2,9); }

  // Initialize state
  let friends = loadFriends();
  let total = loadTotal();

  // If empty, add demo friends so the list is visible immediately (remove if you don't want this)
  if (friends.length === 0) {
    friends = [
      { id: uid(), name: 'Emma', count: 0 },
      { id: uid(), name: 'Lucas', count: 0 }
    ];
    saveFriends(friends);
    console.info('Liste d\'ami¬∑e¬∑s initialis√©e avec des exemples (Emma, Lucas).');
  }

  // Escape helper
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

  // Render friends list
  function renderFriends(){
    if (!friendsListEl) return;
    friendsListEl.innerHTML = '';
    if (friends.length === 0){
      friendsListEl.innerHTML = '<div class="small" style="text-align:center;padding:.8rem;color:var(--muted)">Aucun¬∑e ami¬∑e ‚Äî ajoute en un¬∑e ci‚Äëdessous.</div>';
      updateHeroTotal();
      return;
    }
    friends.forEach(f => {
      const el = document.createElement('div');
      el.className = 'friend';
      el.dataset.id = f.id;
      el.innerHTML = `
        <div class="left">
          <label style="display:flex;align-items:center;gap:.6rem;cursor:pointer">
            <input type="checkbox" class="sel" aria-label="S√©lectionner ${escapeHtml(f.name)}">
            <span class="name">${escapeHtml(f.name)}</span>
          </label>
        </div>
        <div class="controls">
          <div class="count-badge" aria-live="polite">${f.count}</div>
          <button class="btn-ghost btn-remove" title="Supprimer ${escapeHtml(f.name)}" aria-label="Supprimer">‚úñ</button>
        </div>
      `;
      // attach handlers
      const removeBtn = el.querySelector('.btn-remove');
      const checkbox = el.querySelector('.sel');
      removeBtn && removeBtn.addEventListener('click', ()=>{
        if (!confirm(`Supprimer ${f.name} ?`)) return;
        friends = friends.filter(x => x.id !== f.id);
        saveFriends(friends);
        renderFriends();
      });
      checkbox && checkbox.addEventListener('change', updateSelectedCount);
      friendsListEl.appendChild(el);
    });
    updateSelectedCount();
    updateHeroTotal();
  }

  // Selection helpers
  function getSelectedIds(){
    if (!friendsListEl) return [];
    const checks = Array.from(friendsListEl.querySelectorAll('.sel'));
    return checks.filter(c=>c.checked).map(c => c.closest('.friend').dataset.id);
  }
  function updateSelectedCount(){
    const n = getSelectedIds().length;
    if (friendsTitle) friendsTitle.textContent = `Liste d'ami¬∑e¬∑s${n ? ' ‚Äî ' + n + ' s√©lectionn√©'+(n>1?'¬∑e¬∑s':'') : ''}`;
  }

  // Add friend
  function addFriend(){
    if (!friendNameInput) return;
    const name = friendNameInput.value.trim();
    if (!name) return;
    if (friends.some(p => p.name.toLowerCase() === name.toLowerCase())){
      alert('Cette personne existe d√©j√†.');
      friendNameInput.value = '';
      return;
    }
    const newF = { id: uid(), name, count: 0 };
    friends.push(newF);
    saveFriends(friends);
    friendNameInput.value = '';
    friendNameInput.focus();
    renderFriends();
  }
  addFriendBtn && addFriendBtn.addEventListener('click', addFriend);
  friendNameInput && friendNameInput.addEventListener('keydown', e=>{
    if (e.key === 'Enter'){ e.preventDefault(); addFriend(); }
  });

  // Hug logic
  function saveTotalState(){ saveTotal(total); }
  function hugIds(ids){
    if (!ids || ids.length === 0) return;
    friends = friends.map(f => ids.includes(f.id) ? {...f, count: (f.count||0)+1} : f );
    total += ids.length;
    saveFriends(friends);
    saveTotalState();
    renderFriends();
    showEmojiBurst(Math.min(8, ids.length*2));
  }

  hugSelectedBtn && hugSelectedBtn.addEventListener('click', ()=>{
    const ids = getSelectedIds();
    if (ids.length === 0){ alert('Aucune personne s√©lectionn√©e.'); return; }
    hugIds(ids);
  });
  hugAllBtn && hugAllBtn.addEventListener('click', ()=>{
    if (friends.length === 0){ alert('Aucun¬∑e ami¬∑e √† c√¢liner.'); return; }
    hugIds(friends.map(f=>f.id));
  });
  resetAllBtn && resetAllBtn.addEventListener('click', ()=>{
    if (!confirm('R√©initialiser tous les compteurs ?')) return;
    friends = friends.map(f => ({...f, count:0}));
    total = 0;
    saveFriends(friends); saveTotalState();
    renderFriends();
  });

  // select/clear helpers
  selectAllBtn && selectAllBtn.addEventListener('click', ()=>{
    document.querySelectorAll('.friends-list .sel').forEach(c=>c.checked=true);
    updateSelectedCount();
  });
  clearSelBtn && clearSelBtn.addEventListener('click', ()=>{
    document.querySelectorAll('.friends-list .sel').forEach(c=>c.checked=false);
    updateSelectedCount();
  });

  // Hero button: hug selected or increment global
  heroBtn && heroBtn.addEventListener('click', ()=>{
    const ids = getSelectedIds();
    if (ids.length > 0) hugIds(ids);
    else {
      total += 1;
      saveTotalState();
      updateHeroTotal();
      showEmojiBurst(6);
    }
  });

  // Emoji burst
  function showEmojiBurst(n){
    const emojis = ['ü§ó','üíñ','‚ú®','ü§ç'];
    for (let i=0;i<Math.min(n,12);i++){
      const el = document.createElement('div');
      el.className = 'emoji-fly';
      el.style.left = `calc(50% + ${Math.floor(Math.random()*240 - 120)}px)`;
      el.style.bottom = `${110 + Math.floor(Math.random()*30)}%`;
      el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      document.body.appendChild(el);
      setTimeout(()=> el.style.animationDelay = (i*40)+'ms', 10);
      setTimeout(()=> el.remove(), 1500 + i*80);
    }
  }

  // Update hero total
  function updateHeroTotal(){
    if (heroTotalCountEl) heroTotalCountEl.textContent = total;
  }

  // Storage sync across tabs
  window.addEventListener('storage', e=>{
    if (e.key === FRIENDS_KEY){
      friends = loadFriends();
      renderFriends();
    } else if (e.key === TOTAL_KEY){
      total = loadTotal();
      updateHeroTotal();
    }
  });

  // Initial render
  updateHeroTotal();
  renderFriends();
  friendNameInput && friendNameInput.focus();

  // Debug info in console
  console.info('CalinWorld initialis√© ‚Äî amis:', friends.length, 'total c√¢lins:', total);
});
</script>
